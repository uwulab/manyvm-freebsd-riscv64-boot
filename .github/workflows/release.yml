name: release

on:
  push:
    tags:
      - 'v*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  linux:
    runs-on: ubuntu-latest

    steps:
      - name: fetch and release
        run: |
          pip3 install -U lastversion
          FREEBSD_MAJOR_VER=$(lastversion --sem major freebsd)
          FREEBSD_ARCH=amd64
          REPO_BASE_URL="http://pkg.freebsd.org/FreeBSD:${FREEBSD_MAJOR_VER}:${FREEBSD_ARCH}/latest"
          ROOT_DIR=$(pwd)
          OUTPUT_DIR="${ROOT_DIR}/riscv64"
          VERSIONS="${GITHUB_REF##*/v}"
          UBOOT_VERSION=$(echo $VERSIONS | awk -F'-' '{print $1}')
          OPENSBI_VERSION=$(echo $VERSIONS | awk -F'-' '{print $2}')
          
          sudo apt install -y zstd curl
          
          UBOOT_URL="${REPO_BASE_URL}/All/u-boot-qemu-riscv64-${UBOOT_VERSION}.pkg"
          OPENSBI_URL="${REPO_BASE_URL}/All/opensbi-${OPENSBI_VERSION}.pkg"
          
          mkdir -p "${OUTPUT_DIR}"
          
          mkdir -p "${ROOT_DIR}/uboot"
          cd "${ROOT_DIR}/uboot"
          curl -fSL "${UBOOT_URL}" -o u-boot-qemu-riscv64.tar.zst
          zstd -d u-boot-qemu-riscv64.tar.zst
          tar -xf u-boot-qemu-riscv64.tar
          cp usr/local/share/u-boot/u-boot-qemu-riscv64/u-boot.bin "${OUTPUT_DIR}"
          
          mkdir -p "${ROOT_DIR}/opensbi"
          cd "${ROOT_DIR}/opensbi"
          curl -fSL "${OPENSBI_URL}" -o opensbi.tar.zst
          zstd -d opensbi.tar.zst
          tar -xf opensbi.tar
          cp usr/local/share/opensbi/lp64/generic/firmware/fw_jump.bin "${OUTPUT_DIR}"

      - uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            riscv64/*.bin
